<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Chiranjeevi Health Screening</title>
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<!-- No client-side MediaPipe needed ‚Äî all processing is backend -->
		<style>
			:root {
				--bg-primary: #f8f9fa;
				--bg-secondary: #ffffff;
				--bg-card: #ffffff;
				--border-color: #dadce0;
				--text-primary: #202124;
				--text-secondary: #5f6368;
				--accent-blue: #1a73e8;
				--success: #1e8e3e;
				--error: #d93025;
				--warning: #f9ab00;
			}

			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family:
					"Inter",
					-apple-system,
					system-ui,
					sans-serif;
				background: var(--bg-primary);
				color: var(--text-primary);
				height: 100vh;
				width: 100vw;
				overflow: hidden;
				display: flex;
			}

			/* ========================================= */
			/* LEFT PANEL: CAMERA                        */
			/* ========================================= */
			.camera-panel {
				flex: 1;
				position: relative;
				background: #000;
				display: flex;
				align-items: center;
				justify-content: center;
				overflow: hidden;
				margin: 16px;
				border-radius: 24px;
				box-shadow:
					0 4px 6px rgba(0, 0, 0, 0.05),
					0 1px 3px rgba(0, 0, 0, 0.1);
			}

			.camera-panel img {
				position: absolute;
				width: 100%;
				height: 100%;
				object-fit: cover;
				transform: scaleX(-1);
			}

			.camera-overlay-message {
				position: absolute;
				z-index: 20;
				color: #fff;
				text-align: center;
				pointer-events: none;
				background: rgba(0, 0, 0, 0.4);
				padding: 24px;
				border-radius: 20px;
				backdrop-filter: blur(4px);
			}

			.camera-overlay-message .icon {
				font-size: 48px;
				margin-bottom: 12px;
				display: block;
			}

			/* Camera Badge */
			.camera-badge {
				position: absolute;
				top: 24px;
				left: 24px;
				z-index: 30;
				background: var(--error);
				color: white;
				font-size: 11px;
				font-weight: 700;
				padding: 6px 12px;
				border-radius: 20px;
				display: none;
				align-items: center;
				gap: 6px;
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}

			.camera-badge.live {
				display: flex;
			}

			/* ========================================= */
			/* RIGHT PANEL: CONTROLS & INFO              */
			/* ========================================= */
			.control-panel {
				width: 460px;
				padding: 40px 32px;
				display: flex;
				flex-direction: column;
				height: 100%;
				overflow-y: auto;
				gap: 24px;
			}

			header {
				margin-bottom: 12px;
			}
			.logo {
				font-size: 11px;
				font-weight: 700;
				letter-spacing: 2px;
				text-transform: uppercase;
				color: var(--accent-blue);
				margin-bottom: 6px;
			}
			h1 {
				font-size: 28px;
				font-weight: 600;
				color: var(--text-primary);
				letter-spacing: -0.5px;
			}
			.subtitle {
				font-size: 15px;
				color: var(--text-secondary);
				margin-top: 4px;
			}

			/* Cards */
			.card {
				background: var(--bg-card);
				border: 1px solid var(--border-color);
				padding: 24px;
				border-radius: 24px;
				transition: box-shadow 0.2s;
			}
			.card:hover {
				box-shadow: 0 10px 25px rgba(0, 0, 0, 0.02);
			}

			.card-title {
				font-size: 15px;
				font-weight: 600;
				margin-bottom: 20px;
				color: var(--text-primary);
				display: flex;
				align-items: center;
				gap: 12px;
			}
			.card-title::before {
				content: "";
				width: 4px;
				height: 18px;
				background: var(--accent-blue);
				border-radius: 4px;
			}

			/* Instruction Section */
			.instruction-animation {
				width: 100%;
				height: 100px;
				background: #f1f3f4;
				border-radius: 16px;
				margin-bottom: 24px;
				display: flex;
				align-items: center;
				justify-content: center;
			}
			.instruction-animation .circle-ripple {
				width: 16px;
				height: 16px;
				background: var(--accent-blue);
				border-radius: 50%;
				animation: pulse 1.2s infinite alternate;
			}
			@keyframes pulse {
				0% {
					transform: scale(1);
					opacity: 0.4;
				}
				100% {
					transform: scale(1.8);
					opacity: 1;
				}
			}

			.phase-instruction {
				font-size: 14px;
				color: var(--text-secondary);
				line-height: 1.6;
			}
			.phase-instruction strong {
				color: var(--text-primary);
				display: block;
				font-size: 17px;
				margin-bottom: 6px;
				font-weight: 600;
			}

			/* Sensor Grid */
			.sensor-grid {
				display: grid;
				grid-template-columns: repeat(3, 1fr);
				gap: 12px;
			}
			.sensor-card {
				background: #ffffff;
				border: 1px solid var(--border-color);
				padding: 16px 12px;
				text-align: center;
				border-radius: 16px;
			}
			.sensor-card.connected {
				border-color: var(--success);
				background: #e6f4ea;
			}
			.sensor-card.disconnected {
				opacity: 0.6;
			}

			.sensor-icon {
				font-size: 20px;
				display: block;
				margin-bottom: 6px;
			}
			.sensor-name {
				font-size: 10px;
				font-weight: 700;
				text-transform: uppercase;
				color: var(--text-secondary);
			}
			.status-label {
				font-size: 11px;
				font-weight: 600;
				margin-top: 6px;
			}
			.sensor-card.connected .status-label {
				color: var(--success);
			}

			/* Buttons */
			.camera-controls {
				display: flex;
				gap: 12px;
				margin-bottom: 20px;
			}
			.btn-camera {
				flex: 1;
				padding: 14px;
				font-size: 12px;
				font-weight: 600;
				border: 1px solid var(--border-color);
				background: #fff;
				color: var(--text-primary);
				cursor: pointer;
				border-radius: 12px;
				transition: background 0.2s;
			}
			.btn-camera-start {
				border-color: var(--accent-blue);
				color: var(--accent-blue);
			}
			.btn-camera-start:hover {
				background: #e8f0fe;
			}
			.btn-camera-stop {
				border-color: var(--error);
				color: var(--error);
			}
			.btn-camera-stop:hover {
				background: #fde8e8;
			}
			.btn-camera:disabled {
				opacity: 0.3;
				cursor: not-allowed;
			}

			.btn-primary {
				width: 100%;
				padding: 16px;
				background: var(--accent-blue);
				color: #fff;
				border: none;
				font-weight: 600;
				font-size: 15px;
				border-radius: 12px;
				cursor: pointer;
				margin-top: 20px;
				box-shadow: 0 4px 12px rgba(26, 115, 232, 0.2);
				transition: all 0.2s ease;
			}
			.btn-primary:hover {
				background: #1967d2;
				box-shadow: 0 6px 16px rgba(26, 115, 232, 0.3);
				transform: translateY(-1px);
			}
			.btn-primary:active {
				transform: translateY(0);
			}

			.btn-outline {
				background: transparent;
				color: var(--accent-blue);
				border: 1px solid var(--accent-blue);
				box-shadow: none;
			}
			.btn-outline:hover {
				background: #e8f0fe;
				box-shadow: none;
			}

			/* Form Controls */
			.form-group {
				margin-bottom: 20px;
			}
			label {
				font-size: 11px;
				font-weight: 700;
				color: var(--text-secondary);
				text-transform: uppercase;
				margin-bottom: 8px;
				display: block;
				letter-spacing: 0.5px;
			}
			input {
				width: 100%;
				padding: 14px;
				background: #fff;
				border: 1px solid var(--border-color);
				color: var(--text-primary);
				font-family: inherit;
				font-size: 15px;
				border-radius: 12px;
			}
			input:focus {
				border-color: var(--accent-blue);
				outline: none;
				box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
			}

			/* Progress */
			.step-item {
				display: flex;
				align-items: center;
				gap: 16px;
				padding: 16px 0;
				border-bottom: 1px solid var(--border-color);
				font-size: 14px;
				color: var(--text-secondary);
				font-weight: 500;
			}
			.step-item:last-child {
				border-bottom: none;
			}
			.step-item.active {
				color: var(--text-primary);
				font-weight: 600;
			}
			.step-item.completed {
				color: var(--success);
			}
			.step-circle {
				width: 24px;
				height: 24px;
				border: 2px solid var(--border-color);
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 11px;
				font-weight: 700;
			}
			.step-item.active .step-circle {
				border-color: var(--accent-blue);
				color: var(--accent-blue);
			}
			.step-item.completed .step-circle {
				border-color: var(--success);
				background: var(--success);
				color: #fff;
			}

			#statusMessage {
				margin-top: 16px;
				padding: 20px;
				border-radius: 16px;
				background: #e8f0fe;
				color: var(--accent-blue);
				font-weight: 600;
				font-size: 14px;
				display: flex;
				align-items: center;
				gap: 12px;
			}

			.phase-alert {
				background: var(--error);
				border: none;
				color: white;
				padding: 16px;
				border-radius: 12px;
				font-size: 14px;
				font-weight: 700;
				margin-top: 16px;
				display: none;
				align-items: center;
				justify-content: center;
				gap: 10px;
				box-shadow: 0 4px 12px rgba(217, 48, 37, 0.2);
			}
			.phase-alert.visible {
				display: flex;
			}

			@media (max-width: 900px) {
				body {
					flex-direction: column;
					overflow-y: auto;
					height: auto;
				}
				.camera-panel {
					height: 50vh;
					min-height: 350px;
					margin: 10px;
				}
				.control-panel {
					width: 100%;
					height: auto;
					padding: 24px;
				}
			}

			/* AI Processing Overlay */
			.ai-processing-overlay {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.6);
				backdrop-filter: blur(12px);
				-webkit-backdrop-filter: blur(12px);
				display: none;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				z-index: 50;
				color: white;
				text-align: center;
			}
			.ai-spinner {
				width: 50px;
				height: 50px;
				border: 4px solid rgba(255, 255, 255, 0.3);
				border-top: 4px solid var(--accent-blue);
				border-radius: 50%;
				animation: spin 1s linear infinite;
				margin-bottom: 20px;
			}
			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}
		</style>
	</head>
	<body>
		<!-- LEFT: CAMERA PANEL -->
		<div class="camera-panel" id="cameraPanel">
			<div class="camera-badge" id="liveBadge">
				<span class="live-dot"></span> LIVE
			</div>

			<div class="camera-overlay-message" id="cameraPlaceholder">
				<span class="icon">üì∑</span>
				<h2>Camera Feed Loading</h2>
				<p>Connecting to backend camera...</p>
			</div>
			
			<div class="ai-processing-overlay" id="aiOverlay">
				<div class="ai-spinner"></div>
				<h2 style="font-size: 24px; margin-bottom: 8px;">AI Analysis In Progress</h2>
				<p style="opacity: 0.9; font-size: 14px;">Generating comprehensive health report...</p>
			</div>

			<img
				id="cameraFeed"
				src="http://localhost:8000/api/v1/hardware/video-feed"
				style="display: none"
				alt="Live Camera Feed"
			/>
		</div>

		<!-- RIGHT: CONTROLS PANEL -->
		<div class="control-panel">
			<header>
				<div class="logo">Chiranjeevi</div>
				<h1>Health Screening</h1>
				<p class="subtitle">Non-invasive AI health analysis</p>
			</header>

			<!-- DEBUG CONSOLE -->


			<!-- 1. SENSORS & CAMERA CONTROLS -->
			<div class="card">
				<h2 class="card-title">System Controls</h2>

				<div class="camera-controls">
					<button
						class="btn-camera btn-camera-start"
						id="startCameraBtn"
						onclick="toggleCamera()"
					>
						‚ñ∂ Show Camera
					</button>
				</div>

				<div class="sensor-grid">
					<div class="sensor-card disconnected" id="sensorCamera">
						<span class="sensor-icon">üì∑</span>
						<div class="sensor-name">RGB</div>
						<div class="status-label">Disc.</div>
					</div>
					<div class="sensor-card disconnected" id="sensorEsp32">
						<span class="sensor-icon">üå°Ô∏è</span>
						<div class="sensor-name">Thermal</div>
						<div class="status-label">Disc.</div>
					</div>
					<div class="sensor-card disconnected" id="sensorRadar">
						<span class="sensor-icon">üì°</span>
						<div class="sensor-name">Radar</div>
						<div class="status-label">Disc.</div>
					</div>
				</div>

				<button
					class="btn-primary btn-outline"
					id="checkSensorsBtn"
					onclick="checkSensors()"
				>
					Check Sensor Connectivity
				</button>
			</div>

			<!-- 2. CONFIGURATION FORM -->
			<div class="card" id="configCard">
				<h2 class="card-title">Configuration</h2>
				<form id="screeningForm">
					<div class="form-group">
						<label>Patient ID</label>
						<input type="text" id="patientId" value="PATIENT_001" />
					</div>
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
						<div class="form-group">
							<label>Radar Port</label>
							<input type="text" id="radarPort" value="COM7" />
						</div>
						<div class="form-group">
							<label>Thermal Port</label>
							<input type="text" id="esp32Port" value="COM6" />
						</div>
					</div>
					<button type="submit" class="btn-primary" id="startBtn">
						Start Screening Flow
					</button>
				</form>
			</div>

			<!-- 3. SCREENING GUIDE -->
			<div class="card instruction-card">
				<h2 class="card-title">Screening Guide</h2>

				<div class="instruction-animation">
					<div class="circle-ripple"></div>
				</div>

				<div class="phase-instruction" id="phaseInstruction">
					<strong>Ready to Start</strong>
					Please ensure all sensors are connected. Stand in the center of the
					frame.
				</div>

				<div class="phase-alert" id="phaseAlert">
					<span id="phaseAlertIcon">‚ö†Ô∏è</span>
					<span id="phaseAlertText">Alert text here</span>
				</div>

				<div
					id="activeBiomarkers"
					style="margin-top: 16px; display: flex; flex-wrap: wrap; gap: 6px"
				></div>
			</div>

			<!-- 4. STATUS & RESULTS -->
			<div class="card status-card" id="statusCard" style="display: none">
				<h2 class="card-title">Status</h2>

				<div class="step-list" id="progressSteps">
					<div class="step-item" data-step="init">
						<div class="step-circle">1</div>
						Initializing
					</div>
					<div class="step-item" data-step="capture">
						<div class="step-circle">2</div>
						Face Analysis (10s)
					</div>
					<div class="step-item" data-step="pose">
						<div class="step-circle">3</div>
						Body Analysis (10s)
					</div>
					<div class="step-item" data-step="process">
						<div class="step-circle">4</div>
						AI Processing
					</div>
				</div>

				<div
					id="statusMessage"
					style="
						padding: 12px;
						border-radius: 8px;
						background: rgba(99, 102, 241, 0.1);
						color: white;
						display: flex;
						gap: 10px;
						align-items: center;
						font-size: 14px;
					"
				>
					<span>‚è≥</span> <span id="statusText">Waiting...</span>
				</div>

				<div id="downloadSection" style="margin-top: 16px; display: none">
					<a
						href="#"
						class="btn-primary"
						id="downloadPatient"
						target="_blank"
						style="
							display: block;
							text-align: center;
							text-decoration: none;
							margin-bottom: 8px;
						"
						>Download Patient Report</a
					>
				</div>
			</div>

			<div
				style="
					text-align: center;
					color: var(--text-secondary);
					font-size: 11px;
					margin-top: auto;
					padding-top: 20px;
				"
			>
				Chiranjeevi v2.0 ‚Ä¢ Unified Architecture
			</div>
		</div>

		<script>
			const API_BASE = "http://localhost:8000";
			let cameraShowing = false;
			let pollInterval = null;



			// ===== CAMERA TOGGLE (backend-owned MJPEG stream) =====
			function toggleCamera() {
				const feed = document.getElementById("cameraFeed");
				const placeholder = document.getElementById("cameraPlaceholder");
				const badge = document.getElementById("liveBadge");
				const btn = document.getElementById("startCameraBtn");

				if (!cameraShowing) {
					// Show MJPEG stream from backend
					feed.src = `${API_BASE}/api/v1/hardware/video-feed?t=${Date.now()}`;
					feed.style.display = "block";
					placeholder.style.display = "none";
					badge.style.display = "flex";
					btn.textContent = "‚èπ Hide Camera";
					btn.className = "btn-camera btn-camera-stop";
					cameraShowing = true;
					console.log("[info] Camera feed connected (backend MJPEG)");
				} else {
					// Hide stream (but backend keeps capturing)
					feed.style.display = "none";
					feed.src = "";
					placeholder.style.display = "flex";
					badge.style.display = "none";
					btn.textContent = "‚ñ∂ Show Camera";
					btn.className = "btn-camera btn-camera-start";
					cameraShowing = false;
					console.log("[info] Camera feed hidden (backend still capturing)");
				}
			}

			// ===== CHECK SENSORS =====
			async function checkSensors() {
				try {
					const res = await fetch(`${API_BASE}/api/v1/hardware/sensor-status`);
					const data = await res.json();

					updateSensorCard("sensorCamera", data.camera);
					updateSensorCard("sensorEsp32", data.esp32);
					updateSensorCard("sensorRadar", data.radar);
					console.log("[info] Sensor check complete");
				} catch (e) {
					console.error(`[error] Sensor check failed: ${e.message}`);
				}
			}

			function updateSensorCard(cardId, sensorData) {
				const card = document.getElementById(cardId);
				if (!card) return;
				const isConnected = sensorData.status === "connected";
				card.className = `sensor-card ${isConnected ? "connected" : "disconnected"}`;
				const label = card.querySelector(".status-label");
				if (label) label.textContent = isConnected ? "Online" : "Disc.";
			}

			// ===== PHASE UI =====
			function updatePhaseUI(phase, message) {
				const instruction = document.getElementById("phaseInstruction");
				const texts = {
					IDLE: [
						"SYSTEM READY",
						"Please ensure all sensors are connected. Stand in the center of the frame.",
					],
					INITIALIZING: ["INITIALIZING", "Preparing sensors for analysis..."],
					FACE_ANALYSIS: [
						"FACE ANALYSIS",
						message || "Analyzing facial features and vital signs...",
					],
					BODY_ANALYSIS: [
						"BODY ANALYSIS",
						message || "Analyzing posture and movement patterns...",
					],
					PROCESSING: [
						"AI DATA FUSION",
						message || "Running biomarker extraction and risk assessment...",
					],
					COMPLETE: [
						"SCREENING COMPLETE",
						"Your health report is ready for download.",
					],
					ERROR: ["ERROR", message || "An error occurred during screening."],
				};
				const [title, desc] = texts[phase] || [
					"PROCESSING",
					message || "Please wait...",
				];
				instruction.innerHTML = `<strong>${title}</strong>${desc}`;

				// Update biomarker tags
				const marks = {
					FACE_ANALYSIS: ["rPPG", "Ocular", "Thermal", "Skin", "Nasal"],
					BODY_ANALYSIS: ["Skeletal", "Gait", "Posture", "Balance"],
					PROCESSING: ["Fusion", "Risk", "LLM", "Report"],
				};
				const tagList = marks[phase] || [];
				const html = tagList
					.map(
						(m) =>
							`<span style="background:#E8F0FE; border: 1px solid var(--accent-blue); padding:4px 8px; font-size:9px; font-weight:700; color:var(--accent-blue); border-radius:6px;">${m}</span>`,
					)
					.join("");
				document.getElementById("activeBiomarkers").innerHTML = html;

				// Update step progress
				const stepMap = {
					INITIALIZING: "init",
					FACE_ANALYSIS: "capture",
					BODY_ANALYSIS: "pose",
					PROCESSING: "process",
					COMPLETE: "done",
				};
				const steps = ["init", "capture", "pose", "process"];
				const activeIdx = steps.indexOf(stepMap[phase] || "");
				document.querySelectorAll(".step-item").forEach((el, i) => {
					el.className = "step-item";
					if (i < activeIdx || phase === "COMPLETE")
						el.classList.add("completed");
					if (i < activeIdx || phase === "COMPLETE")
						el.classList.add("completed");
					else if (i === activeIdx) el.classList.add("active");
				});
				
				// Toggle AI Overlay
				const aiOverlay = document.getElementById("aiOverlay");
				if (phase === "PROCESSING") {
					aiOverlay.style.display = "flex";
				} else {
					aiOverlay.style.display = "none";
				}
			}

			// ===== START SCREENING =====
			async function startScreening(e) {
				console.log("Start button clicked");
				if (e) e.preventDefault();

				// Show status card, hide config
				document.getElementById("statusCard").style.display = "block";
				document.getElementById("configCard").style.opacity = "0.5";
				document.getElementById("startBtn").disabled = true;
				document.getElementById("downloadSection").style.display = "none";

				// Ensure camera is visible
				if (!cameraShowing) toggleCamera();

				updatePhaseUI("INITIALIZING", "Preparing sensors...");
				document.getElementById("statusText").textContent = "Starting...";

				try {
					// Launch scan (non-blocking ‚Äî returns immediately)
					const body = {
						patient_id: document.getElementById("patientId").value,
						radar_port: document.getElementById("radarPort").value,
						esp32_port: document.getElementById("esp32Port").value,
						camera_index: 0,
					};

					console.log("Starting screening...");
					const res = await fetch(
						`${API_BASE}/api/v1/hardware/start-screening`,
						{
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify(body),
						},
					);

					if (!res.ok) {
						const errData = await res.json();
						throw new Error(errData.detail || `Server error: ${res.status}`);
					}

					const data = await res.json();

					if (data.status === "error") {
						throw new Error(data.error || "Failed to start scan");
					}

					console.log("Scan started ‚Äî polling for progress...");

					// Start polling scan status
					pollScanStatus();
				} catch (e) {
					console.error(`Start error: ${e.message}`);
					document.getElementById("statusText").textContent =
						"Error: " + e.message;
					updatePhaseUI("ERROR", e.message);
					resetUI();
				}
			}

			// ===== POLL SCAN STATUS =====
			function pollScanStatus() {
				if (pollInterval) clearInterval(pollInterval);

				pollInterval = setInterval(async () => {
					try {
						const res = await fetch(`${API_BASE}/api/v1/hardware/scan-status`);
						const status = await res.json();

						// Update UI
						updatePhaseUI(status.phase, status.message);
						document.getElementById("statusText").textContent =
							`${status.message} (${status.progress}%)`;

						// Display distance / alignment warnings from backend (Logic Restoration)
						if (status.user_warnings) {
							const { distance_warning, face_detected, pose_detected } = status.user_warnings;
							const alertDiv = document.getElementById("phaseAlert");
							const alertIcon = document.getElementById("phaseAlertIcon");
							const alertText = document.getElementById("phaseAlertText");

							if (distance_warning === "too_close") {
								alertDiv.classList.add("visible");
								alertIcon.textContent = "‚ö†Ô∏è";
								alertText.textContent = "TOO CLOSE ‚Äî Move back from the camera";
							} else if (distance_warning === "too_far") {
								alertDiv.classList.add("visible");
								alertIcon.textContent = "‚ö†Ô∏è";
								alertText.textContent = "TOO FAR ‚Äî Move closer to the camera";
							} else if (status.phase === "FACE_ANALYSIS" && !face_detected) {
								alertDiv.classList.add("visible");
								alertIcon.textContent = "üë§";
								alertText.textContent = "FACE NOT DETECTED ‚Äî Center your face";
							} else if (status.phase === "BODY_ANALYSIS" && !pose_detected) {
								alertDiv.classList.add("visible");
								alertIcon.textContent = "üö∂";
								alertText.textContent = "BODY NOT DETECTED ‚Äî Step back until fully visible";
							} else {
								alertDiv.classList.remove("visible");
							}
						}

						// Check terminal states
						if (status.state === "complete") {
							clearInterval(pollInterval);
							pollInterval = null;
							onScanComplete(status);
						} else if (status.state === "error") {
							clearInterval(pollInterval);
							pollInterval = null;
							onScanError(status.message);
						}
					} catch (e) {
						console.error(`Poll error: ${e.message}`);
					}
				}, 500); // Poll every 500ms
			}

			// ===== SCAN COMPLETE =====
			function onScanComplete(status) {
				console.log("Screening complete!");
				updatePhaseUI("COMPLETE", "Screening complete!");
				document.getElementById("statusText").textContent =
					"‚úÖ Screening complete!";

				// Show download link
				if (status.patient_report_id) {
					document.getElementById("downloadPatient").href =
						`${API_BASE}/api/v1/reports/${status.patient_report_id}/download`;
					document.getElementById("downloadSection").style.display = "block";
				}

				resetUI();
			}

			// ===== SCAN ERROR =====
			function onScanError(msg) {
				console.error(`Scan error: ${msg}`);
				updatePhaseUI("ERROR", msg);
				document.getElementById("statusText").textContent = "‚ùå Error: " + msg;
				resetUI();
			}

			// ===== RESET UI =====
			function resetUI() {
				document.getElementById("configCard").style.opacity = "1";
				document.getElementById("startBtn").disabled = false;
			}

			// ===== ERROR HANDLERS =====
			window.onerror = function (msg, url, line) {
				console.error(`JS Error: ${msg} (Line ${line})`);
				return false;
			};
			window.addEventListener("unhandledrejection", function (event) {
				console.error(`Promise Error: ${event.reason}`);
			});

			// ===== INIT =====
			window.onload = () => {
				// Wire form submit
				const form = document.getElementById("screeningForm");
				if (form) form.addEventListener("submit", startScreening);

				// Auto-connect camera and check sensors
				setTimeout(() => {
					checkSensors();
					toggleCamera(); // Auto-show MJPEG feed
					startContinuousWarningCheck(); // Start continuous distance warning polling
				}, 500);
			};

			// ===== CONTINUOUS WARNING CHECK =====
			let warningCheckInterval = null;
			function startContinuousWarningCheck() {
				// Poll status every 500ms to show distance warnings even before scan starts
				if (warningCheckInterval) clearInterval(warningCheckInterval);

				warningCheckInterval = setInterval(async () => {
					try {
						const res = await fetch(`${API_BASE}/api/v1/hardware/scan-status`);
						const status = await res.json();

						// Only update warnings if not actively scanning (to avoid conflict with pollScanStatus)
						if (status.state === "idle" || status.state === "complete") {
							if (status.user_warnings) {
								const { distance_warning, face_detected } =
									status.user_warnings;
								const alertDiv = document.getElementById("phaseAlert");
								const alertIcon = document.getElementById("phaseAlertIcon");
								const alertText = document.getElementById("phaseAlertText");

								if (distance_warning === "too_close") {
									alertDiv.classList.add("visible");
									alertIcon.textContent = "‚ö†Ô∏è";
									alertText.textContent =
										"TOO CLOSE ‚Äî Please move back from the camera";
								} else if (distance_warning === "too_far") {
									alertDiv.classList.add("visible");
									alertIcon.textContent = "‚ö†Ô∏è";
									alertText.textContent =
										"TOO FAR ‚Äî Please move closer to the camera";
								} else if (!face_detected) {
									alertDiv.classList.add("visible");
									alertIcon.textContent = "üë§";
									alertText.textContent =
										"NO FACE DETECTED ‚Äî Position yourself in frame";
								} else {
									alertDiv.classList.remove("visible");
								}
							}
						}
					} catch (e) {
						// Silent fail for continuous check
					}
				}, 500);
			}
		</script>
	</body>
</html>
