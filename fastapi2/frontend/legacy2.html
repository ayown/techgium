<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Chiranjeevi Health Screening</title>
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<!-- MediaPipe Scripts -->
		<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
		<style>
         :root {
            /* --- MATERIAL 3 COLOR TOKENS (Blue Theme) --- */
            /* Backgrounds */
            --md-sys-color-surface: #FDFBFF;
            --md-sys-color-surface-container-low: #F0F4F8;
            --md-sys-color-surface-container: #EAEFF5;
            --md-sys-color-surface-container-high: #E2E7ED;
            
            /* Primary (Action) */
            --md-sys-color-primary: #0B57D0;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #D3E3FD;
            --md-sys-color-on-primary-container: #041E49;

            /* Secondary (Tonal Elements) */
            --md-sys-color-secondary-container: #C2E7FF;
            --md-sys-color-on-secondary-container: #001D35;

            /* Error / Status */
            --md-sys-color-error: #BA1A1A;
            --md-sys-color-error-container: #FFDAD6;
            --md-sys-color-on-error-container: #410002;
            --md-sys-color-success-container: #C4EED0;
            --md-sys-color-on-success-container: #0F5223;

            /* Text */
            --md-sys-color-on-surface: #1B1B1F;
            --md-sys-color-on-surface-variant: #444746;
            --md-sys-color-outline: #747775;
            --md-sys-color-outline-variant: #C4C7C5;

            /* Layout values */
            --radius-large: 28px;
            --radius-medium: 16px;
            --radius-full: 999px; /* Stadium shape */
         }

         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
         }

         body {
            font-family: 'Google Sans', 'Roboto', sans-serif;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            padding: 16px;
            gap: 16px;
         }

         /* ========================================= */
         /* LEFT PANEL: CAMERA                        */
         /* ========================================= */
         .camera-panel {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: var(--radius-large);
            /* M3 uses tonal difference, but black needs no border */
         }

         .camera-panel img {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
         }

         .camera-overlay-message {
            position: absolute;
            z-index: 20;
            color: var(--md-sys-color-surface-container-low);
            text-align: center;
            pointer-events: none;
            background: rgba(30, 30, 30, 0.6);
            padding: 32px;
            border-radius: var(--radius-large);
            backdrop-filter: blur(8px);
         }

         .camera-overlay-message .icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
            opacity: 0.8;
         }

         /* Camera Badge */
         .camera-badge {
            position: absolute;
            top: 24px;
            left: 24px;
            z-index: 30;
            background: var(--md-sys-color-error);
            color: white;
            font-size: 12px;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: var(--radius-full);
            display: none;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
         }

         .camera-badge.live {
            display: flex;
         }

         .live-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
         }

         @keyframes blink { 50% { opacity: 0.5; } }

         /* ========================================= */
         /* RIGHT PANEL: CONTROLS & INFO              */
         /* ========================================= */
         .control-panel {
            width: 420px;
            padding: 8px; /* Internal padding handled by cards */
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            gap: 16px;
            /* Hide scrollbar for cleaner look */
            scrollbar-width: none; 
         }
         .control-panel::-webkit-scrollbar { display: none; }

         header {
            margin: 8px 4px 16px 4px;
         }
         .logo {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--md-sys-color-primary);
            margin-bottom: 8px;
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--radius-full);
         }
         h1 {
            font-family: 'Google Sans', sans-serif;
            font-size: 32px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
            letter-spacing: -0.5px;
            line-height: 1.2;
         }
         .subtitle {
            font-size: 16px;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 8px;
            font-weight: 400;
         }

         /* M3 Cards (Filled Card Variant) */
         .card {
            background: var(--md-sys-color-surface-container);
            border: none; /* Removed border */
            padding: 24px;
            border-radius: var(--radius-large);
            transition: background 0.2s;
         }

         .card-title {
            font-size: 20px; /* Title Large */
            font-weight: 400;
            margin-bottom: 24px;
            color: var(--md-sys-color-on-surface);
            display: flex;
            align-items: center;
            gap: 12px;
         }
         /* Removed the blue pill bar before title for cleaner M3 look */
         .card-title::before { display: none; }

         /* Sensor Grid */
         .sensor-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
         }
         /* Sensor Chips */
         .sensor-card {
            background: var(--md-sys-color-surface); /* Contrast against card bg */
            border: 1px solid transparent;
            padding: 16px 8px;
            text-align: center;
            border-radius: var(--radius-medium);
            transition: all 0.3s cubic-bezier(0.2, 0.0, 0, 1.0);
         }
         /* Connected State = Primary Container */
         .sensor-card.connected {
            background: var(--md-sys-color-success-container);
            color: var(--md-sys-color-on-success-container);
         }
         .sensor-card.disconnected {
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface-variant);
            opacity: 1; /* M3 doesn't use opacity for disabled usually */
         }

         .sensor-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 8px;
         }
         .sensor-name {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
         }
         .status-label {
            font-size: 12px;
            font-weight: 500;
            margin-top: 4px;
         }

         /* Buttons */
         .camera-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
         }
         /* M3 Segmented Button / Tonal Button Style */
         .btn-camera {
            flex: 1;
            padding: 0 24px;
            height: 48px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            cursor: pointer;
            border-radius: var(--radius-full);
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
         }
         .btn-camera:hover {
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
         }
         .btn-camera-stop {
            background: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
         }

         /* Filled Button (Primary) */
         .btn-primary {
            width: 100%;
            height: 48px;
            padding: 0 24px;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            font-family: 'Google Sans', sans-serif;
            font-weight: 500;
            font-size: 14px;
            letter-spacing: 0.25px;
            border-radius: var(--radius-full);
            cursor: pointer;
            margin-top: 24px;
            box-shadow: none; /* M3 relies on color weight mostly */
            transition: box-shadow 0.2s ease;
         }
         .btn-primary:hover {
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            background: #004A77; /* Slight darken manually or use state layer */
         }

         /* Outlined Button */
         .btn-outline {
            background: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
            margin-top: 16px;
         }
         .btn-outline:hover {
            background: var(--md-sys-color-surface-container-high);
            border-color: var(--md-sys-color-primary);
         }

         /* Form Controls (M3 Text Fields) */
         .form-group {
            margin-bottom: 20px;
            position: relative;
         }
         label {
            font-size: 12px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 8px;
            display: block;
            margin-left: 4px;
         }
         input {
            width: 100%;
            height: 56px;
            padding: 8px 16px;
            background: var(--md-sys-color-surface-container-high);
            border: 1px solid transparent; /* Filled text field style */
            border-bottom: 1px solid var(--md-sys-color-outline);
            color: var(--md-sys-color-on-surface);
            font-family: inherit;
            font-size: 16px;
            border-radius: 4px 4px 0 0; /* Traditional M3 Filled Input radius */
            transition: all 0.2s;
         }
         /* To make it "Expressive", let's use the fully rounded variant sometimes seen */
         input {
            border-radius: 12px;
            border: none;
         }
         
         input:focus {
            background: var(--md-sys-color-surface-container-high);
            outline: 2px solid var(--md-sys-color-primary);
            outline-offset: -2px;
         }

         /* Animation Area */
         .instruction-animation {
            width: 100%;
            height: 120px;
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--radius-medium);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
         }
         .instruction-animation .circle-ripple {
            width: 24px;
            height: 24px;
            background: var(--md-sys-color-primary);
            border-radius: 50%;
            animation: pulse 1.5s cubic-bezier(0.2, 0, 0, 1) infinite;
            box-shadow: 0 0 0 0 rgba(11, 87, 208, 0.7);
         }
         @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(11, 87, 208, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 60px rgba(11, 87, 208, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(11, 87, 208, 0); }
         }

         .phase-instruction {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            line-height: 1.6;
            text-align: center;
         }
         .phase-instruction strong {
            color: var(--md-sys-color-on-surface);
            display: block;
            font-size: 18px; /* Headline Small */
            margin-bottom: 8px;
            font-weight: 500;
         }

         /* Alerts */
         .phase-alert {
            background: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
            padding: 16px;
            border-radius: var(--radius-medium);
            font-size: 14px;
            font-weight: 500;
            margin-top: 16px;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: none;
         }
         .phase-alert.visible { display: flex; }

         /* Progress Stepper */
         .step-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 12px;
            border-radius: 12px; /* Active background radius */
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
            transition: all 0.3s;
            border: none;
         }
         .step-item.active {
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
         }
         .step-circle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface-variant);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
         }
         .step-item.active .step-circle {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
         }
         .step-item.completed .step-circle {
            background: var(--md-sys-color-success-container);
            color: var(--md-sys-color-on-success-container);
            content: "‚úì";
         }

         /* Status Message Box */
         #statusMessage {
            margin-top: 16px;
            padding: 16px;
            border-radius: var(--radius-medium);
            background: var(--md-sys-color-primary-container) !important;
            color: var(--md-sys-color-on-primary-container) !important;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
         }

         /* Responsive */
         @media (max-width: 900px) {
            body {
               flex-direction: column;
               overflow-y: auto;
               height: auto;
               padding: 12px;
            }
            .camera-panel {
               height: 50vh;
               min-height: 350px;
               width: 100%;
               margin: 0;
            }
            .control-panel {
               width: 100%;
               height: auto;
               overflow: visible;
               padding: 0;
            }
         }

         /* AI Overlay */
         .ai-processing-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(16px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            color: white;
         }
         .ai-spinner {
            width: 56px; height: 56px;
            border: 6px solid rgba(255, 255, 255, 0.2);
            border-top: 6px solid var(--md-sys-color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
         }
         @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      </style>
	</head>
	<body>

		<!-- LEFT: CAMERA PANEL -->
		<div class="camera-panel" id="cameraPanel">
			<div class="camera-badge" id="liveBadge">
				<span class="live-dot"></span> LIVE
			</div>
			
			<div class="camera-overlay-message" id="cameraPlaceholder">
				<span class="icon">üì∑</span>
				<h2>Camera Feed Inactive</h2>
				<p>Click "Start Camera" in the controls pipeline to begin.</p>
			</div>

			<video id="inputVideo" playsinline style="display: none;"></video>
			<canvas id="outputCanvas"></canvas>
		</div>

		<!-- RIGHT: CONTROLS PANEL -->
		<div class="control-panel">
			<header>
				<div class="logo">Chiranjeevi</div>
				<h1>Health Screening</h1>
				<p class="subtitle">Non-invasive AI health analysis</p>
			</header>

			<!-- 1. SENSORS & CAMERA CONTROLS -->
			<div class="card">
				<h2 class="card-title">System Controls</h2>
				
				<div class="camera-controls">
					<button class="btn-camera btn-camera-start" id="startCameraBtn" onclick="startCamera()">
						‚ñ∂ Start Camera
					</button>
					<button class="btn-camera btn-camera-stop" id="stopCameraBtn" onclick="stopCamera()" disabled>
						‚èπ Stop Camera
					</button>
				</div>

				<div class="sensor-grid">
					<div class="sensor-card disconnected" id="sensorCamera">
						<span class="sensor-icon">üì∑</span>
						<div class="sensor-name">RGB</div>
						<div class="status-label">Disc.</div>
					</div>
					<div class="sensor-card disconnected" id="sensorEsp32">
						<span class="sensor-icon">üå°Ô∏è</span>
						<div class="sensor-name">Thermal</div>
						<div class="status-label">Disc.</div>
					</div>
					<div class="sensor-card disconnected" id="sensorRadar">
						<span class="sensor-icon">üì°</span>
						<div class="sensor-name">Radar</div>
						<div class="status-label">Disc.</div>
					</div>
				</div>

				<button class="btn-primary btn-outline" id="checkSensorsBtn" onclick="checkSensors()">
					Check Sensor Connectivity
				</button>
			</div>

			<!-- 2. SCREENING GUIDE -->
			<div class="card instruction-card">
				<h2 class="card-title">Screening Guide</h2>
				
				<div class="instruction-animation">
					<div class="circle-ripple"></div>
				</div>

				<div class="phase-instruction" id="phaseInstruction">
					<strong>Ready to Start</strong>
					Please ensure all sensors are connected. Stand in the center of the frame.
				</div>

				<div class="phase-alert" id="phaseAlert">
					<span>‚ö†Ô∏è</span> <span id="alertText">Alert text here</span>
				</div>

				<div id="activeBiomarkers" style="margin-top: 16px; display: flex; flex-wrap: wrap; gap: 6px;"></div>
			</div>

			<!-- 3. CONFIGURATION FORM -->
			<div class="card" id="configCard">
				<h2 class="card-title">Configuration</h2>
				<form id="screeningForm">
					<div class="form-group">
						<label>Patient ID</label>
						<input type="text" id="patientId" value="PATIENT_001">
					</div>
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
						<div class="form-group">
							<label>Radar Port</label>
							<input type="text" id="radarPort" value="COM7">
						</div>
						<div class="form-group">
							<label>Thermal Port</label>
							<input type="text" id="esp32Port" value="COM6">
						</div>
					</div>
					<button type="submit" class="btn-primary" id="startBtn">
						Start Screening Flow
					</button>
				</form>
			</div>

			<!-- 4. STATUS & RESULTS -->
			<div class="card status-card" id="statusCard" style="display: none;">
				<h2 class="card-title">Status</h2>
				
				<div class="step-list" id="progressSteps">
					<div class="step-item" data-step="init"><div class="step-circle">1</div> Initializing</div>
					<div class="step-item" data-step="capture"><div class="step-circle">2</div> Face Analysis (10s)</div>
					<div class="step-item" data-step="pose"><div class="step-circle">3</div> Body Analysis (10s)</div>
					<div class="step-item" data-step="process"><div class="step-circle">4</div> AI Processing</div>
				</div>

				<div id="statusMessage" style="padding: 12px; border-radius: 8px; background: rgba(99,102,241,0.1); color: white; display: flex; gap: 10px; align-items: center; font-size: 14px;">
					<span>‚è≥</span> <span id="statusText">Waiting...</span>
				</div>

				<div id="downloadSection" style="margin-top: 16px; display: none;">
					<a href="#" class="btn-primary" id="downloadPatient" target="_blank" style="display: block; text-align: center; text-decoration: none; margin-bottom: 8px;">Download Patient Report</a>
				</div>
			</div>
			
			<div style="text-align: center; color: var(--text-secondary); font-size: 11px; margin-top: auto; padding-top: 20px;">
				Chiranjeevi v1.0 ‚Ä¢ System Ready
			</div>
		</div>

		<script>
			const API_BASE = "http://localhost:8000";
			let cameraActive = false;
			let currentPhase = 'IDLE';

			const videoElement = document.getElementById('inputVideo');
			const canvasElement = document.getElementById('outputCanvas');
			const canvasCtx = canvasElement.getContext('2d');
			const startBtn = document.getElementById('startBtn');

			// ===== MEDIAPIPE INIT =====
			const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
			faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});

			const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
			pose.setOptions({modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});

			faceMesh.onResults(onFaceResults);
			pose.onResults(onPoseResults);

			function onFaceResults(results) {
				if (currentPhase !== 'FACE' && currentPhase !== 'IDLE') return;
				drawResults(results, 'FACE');
			}

			function onPoseResults(results) {
				if (currentPhase !== 'POSE') return;
				drawResults(results, 'POSE');
			}

			function drawResults(results, type) {
				canvasCtx.save();
				canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
				// Mirror canvas
				canvasCtx.translate(canvasElement.width, 0);
				canvasCtx.scale(-1, 1);
				canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

				if (type === 'FACE' && results.multiFaceLandmarks) {
					for (const landmarks of results.multiFaceLandmarks) {
						drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, {color: 'rgba(139, 92, 246, 0.2)', lineWidth: 1});
						drawConnectors(canvasCtx, landmarks, FACEMESH_RIGHT_EYE, {color: '#8B5CF6', lineWidth: 2});
						drawConnectors(canvasCtx, landmarks, FACEMESH_LEFT_EYE, {color: '#8B5CF6', lineWidth: 2});
						
						// Distance check (approximate)
						const width = Math.abs(landmarks[234].x - landmarks[454].x);
						if (currentPhase === 'FACE' && width < 0.2) showAlert("Move Closer");
						else hideAlert();
					}
				}
				if (type === 'POSE' && results.poseLandmarks) {
					drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#22c55e', lineWidth: 4});
					drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#ffffff', lineWidth: 2, radius: 2});
					
					// Full body check
					if (results.poseLandmarks[30].visibility < 0.5) showAlert("Show Full Body");
					else hideAlert();
				}
				canvasCtx.restore();
			}

			// Camera Logic
			let camera = null;
			function startCamera() {
				// Hide placeholder, show video logic handled by rendering to canvas
				document.getElementById('cameraPlaceholder').style.display = 'none';
				document.getElementById('liveBadge').style.display = 'flex';
				document.getElementById('startCameraBtn').disabled = true;
				document.getElementById('stopCameraBtn').disabled = false;
				
				camera = new Camera(videoElement, {
					onFrame: async () => {
						if (currentPhase === 'POSE') await pose.send({image: videoElement});
						else await faceMesh.send({image: videoElement});
					},
					width: 1280,
					height: 720
				});
				camera.start();
				cameraActive = true;
				resizeCanvas();
			}

			function stopCamera() {
				if (camera) camera.stop();
				document.getElementById('cameraPlaceholder').style.display = 'block';
				document.getElementById('liveBadge').style.display = 'none';
				document.getElementById('startCameraBtn').disabled = false;
				document.getElementById('stopCameraBtn').disabled = true;
				cameraActive = false;
				
				// Clear canvas
				canvasCtx.clearRect(0,0, canvasElement.width, canvasElement.height);
			}

			// Resize canvas to match panel
			function resizeCanvas() {
				const panel = document.getElementById('cameraPanel');
				canvasElement.width = panel.clientWidth;
				canvasElement.height = panel.clientHeight;
			}
			window.addEventListener('resize', resizeCanvas);

			// UI Updates
			function updatePhaseUI(phase, subTask = null) {
				currentPhase = phase;
				const texts = {
					'IDLE': ['SYSTEM READY', 'Please ensure all sensors are connected. Stand in the center of the frame.'],
					'PRE-FACE': ['GET READY: FACE SCAN', 'Position your face within the frame. Analysis starts in 10 seconds.'],
					'FACE': ['PHYSIOLOGICAL ANALYSIS: FACE', subTask || 'Analyzing cardiovascular and ocular biomarkers...'],
					'PRE-POSE': ['GET READY: BODY SCAN', 'Step back to show your full body. Gait analysis starts in 10 seconds.'],
					'POSE': ['KINETIC ANALYSIS: BODY', subTask || 'Analyzing postural and gait stability...'],
					'PROCESSING': ['AI DATA FUSION', 'Generating final health report using Gemini Medical LLM.']
				};
				const [title, desc] = texts[phase] || ['PROCESSING', 'Please wait...'];
				document.getElementById('phaseInstruction').innerHTML = `<strong>${title}</strong>${desc}`;
				
				// Biomarkers
				const marks = {
					'FACE': ['rPPG', 'Ocular', 'Thermal', 'Stress'],
					'POSE': ['Skeletal', 'Gait', 'Posture', 'Balance'],
					'PROCESSING': ['Fusion', 'Risk', 'Report']
				};
				const html = (marks[phase] || []).map(m => `<span style="background:#000; border: 1px solid #333; padding:4px 8px; font-size:9px; font-weight:700; color:var(--accent-blue);">${m}</span>`).join('');
				document.getElementById('activeBiomarkers').innerHTML = html;
			}

			// ... (showAlert/hideAlert/checkSensors/updateSensor remain the same)

			// Flow Simulation
			document.getElementById('screeningForm').addEventListener('submit', async (e) => {
				e.preventDefault();
				if (!cameraActive) startCamera();
				
				document.getElementById('configCard').style.display = 'none';
				document.getElementById('statusCard').style.display = 'block';
				
				// Updated Flow with Positioning Delays
				// Sequence: INIT -> PRE-FACE (10s) -> FACE (20s) -> PRE-POSE (10s) -> POSE (20s) -> PROCESS
				
				const timeline = [
					{ step: 'init', phase: 'IDLE', duration: 2000 },
					{ step: 'capture', phase: 'PRE-FACE', duration: 10000 },
					{ step: 'capture', phase: 'FACE', duration: 20000 },
					{ step: 'pose', phase: 'PRE-POSE', duration: 10000 },
					{ step: 'pose', phase: 'POSE', duration: 20000 },
					{ step: 'process', phase: 'PROCESSING', duration: 5000 }
				];
				
				let idx = 0;
				
				function runNextPhase() {
					if (idx >= timeline.length) {
						submitRealRequest(); 
						return;
					}

					const current = timeline[idx];
					
					// Update Stepper UI
					document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
					const stepEl = document.querySelector(`[data-step="${current.step}"]`);
					if (stepEl) {
						stepEl.classList.add('active');
						if (idx > 0 && timeline[idx-1].step !== current.step) {
							const prevEl = document.querySelector(`[data-step="${timeline[idx-1].step}"]`);
							if (prevEl) prevEl.classList.add('completed');
						}
					}
					
					// Sequential Logic for sub-tasks during Analysis
					let subTasks = [];
					if (current.phase === 'FACE') {
						subTasks = [
							"Acquiring Heart Rate (rPPG)...",
							"Analyzing Ocular Stability...",
							"Scanning Thermal Biomarkers...",
							"Detecting Stress Indicators..."
						];
					} else if (current.phase === 'POSE') {
						subTasks = [
							"Mapping Skeletal Structure...",
							"Analyzing Gait & Balance...",
							"Checking Posture Alignment...",
							"Finalizing Biomechanics..."
						];
					}

					// Initial UI Update
					updatePhaseUI(current.phase, subTasks.length > 0 ? subTasks[0] : null);
					
					// Update Status Text & Countdowns
					let timeLeft = current.duration / 1000;
					const subTaskInterval = current.duration / 4; // Cycle 4 sub-tasks every phase
					
					const timerInterval = setInterval(() => {
						timeLeft--;
						if (timeLeft >= 0) {
							let phaseLabel = current.phase.replace('PRE-', 'GET READY: ');
							document.getElementById('statusText').textContent = `${phaseLabel} (${timeLeft}s)`;
							
							// Cycle sub-tasks every 5s (for a 20s phase)
							if (subTasks.length > 0) {
								const subIdx = Math.floor((current.duration - (timeLeft * 1000)) / subTaskInterval);
								if (subTasks[subIdx]) {
									updatePhaseUI(current.phase, subTasks[subIdx]);
								}
							}
						}
					}, 1000);

					setTimeout(() => {
						clearInterval(timerInterval);
						idx++;
						runNextPhase();
					}, current.duration);
				}

				runNextPhase();
			});


			async function submitRealRequest() {
				try {
					const body = {
						patient_id: document.getElementById('patientId').value,
						radar_port: document.getElementById('radarPort').value,
						esp32_port: document.getElementById('esp32Port').value,
						camera_index: 0
					};
					const res = await fetch(`${API_BASE}/api/v1/hardware/start-screening`, {
						method: 'POST',
						headers: {'Content-Type': 'application/json'},
						body: JSON.stringify(body)
					});
					const data = await res.json();
					if (data.status === 'success') {
						document.getElementById('statusText').textContent = "Complete!";
						document.getElementById('downloadSection').style.display = 'block';
						if (data.patient_report_id) {
							document.getElementById('downloadPatient').href = `${API_BASE}/api/v1/reports/${data.patient_report_id}/download`;
						}
					}
				} catch(e) {
					document.getElementById('statusText').textContent = "Error: " + e.message;
				}
			}

			// Init
			window.onload = () => {
				setTimeout(checkSensors, 1000);
			};
		</script>
	</body>
</html>